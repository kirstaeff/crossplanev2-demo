---
# Composition for StaticCluster using Crossplane v2
# This Composition uses HARDCODED, OPINIONATED values
# Platform team controls all versions, configurations, and settings
# Users only specify the target cluster - everything else is predetermined
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
    name: static-cluster
    labels:
        crossplane.io/xrd: xstaticclusters.bootstrap.crossplane.io
        config-pattern: static
spec:
    # Reference to the XRD this Composition satisfies
    compositeTypeRef:
        apiVersion: bootstrap.crossplane.io/v1alpha1
        kind: XStaticCluster

    # Pipeline mode uses Composition Functions (v2 pattern)
    mode: Pipeline

    # Pipeline defines the sequence of Composition Functions to execute
    pipeline:
        # Step 1: Use patch-and-transform function to generate resources
        - step: patch-and-transform
          functionRef:
              name: function-patch-and-transform
          input:
              apiVersion: pt.fn.crossplane.io/v1beta1
              kind: Resources

              # Resources defines the managed resources to create
              # ALL VALUES ARE HARDCODED - users cannot customize
              resources:
                  # Resource 1: Create cert-manager namespace
                  - name: cert-manager-namespace
                    base:
                        apiVersion: kubernetes.crossplane.io/v1alpha2
                        kind: Object
                        metadata:
                            name: cert-manager-namespace
                        spec:
                            forProvider:
                                manifest:
                                    apiVersion: v1
                                    kind: Namespace
                                    metadata:
                                        name: cert-manager
                                        labels:
                                            config-pattern: static
                                            managed-by: crossplane

                    patches:
                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.providerConfigRef
                          toFieldPath: spec.providerConfigRef.name

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: metadata.name
                          transforms:
                              - type: string
                                string:
                                    fmt: "%s-cert-manager-namespace"
                                    type: Format

                  # Resource 2: Create ingress-nginx namespace
                  - name: ingress-nginx-namespace
                    base:
                        apiVersion: kubernetes.crossplane.io/v1alpha2
                        kind: Object
                        metadata:
                            name: ingress-nginx-namespace
                        spec:
                            forProvider:
                                manifest:
                                    apiVersion: v1
                                    kind: Namespace
                                    metadata:
                                        name: ingress-nginx
                                        labels:
                                            config-pattern: static
                                            managed-by: crossplane

                    patches:
                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.providerConfigRef
                          toFieldPath: spec.providerConfigRef.name

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: metadata.name
                          transforms:
                              - type: string
                                string:
                                    fmt: "%s-ingress-nginx-namespace"
                                    type: Format

                  # Resource 3: Install cert-manager operator via Helm
                  # VERSION AND VALUES ARE HARDCODED - no user customization
                  - name: cert-manager-release
                    base:
                        apiVersion: helm.crossplane.io/v1beta1
                        kind: Release
                        metadata:
                            name: cert-manager
                        spec:
                            rollbackLimit: 3
                            forProvider:
                                chart:
                                    name: cert-manager
                                    repository: https://charts.jetstack.io
                                    version: v1.13.3 # HARDCODED VERSION
                                namespace: cert-manager
                                # HARDCODED VALUES - opinionated defaults
                                set:
                                    - name: installCRDs
                                      value: "true"
                                    - name: replicaCount
                                      value: "2"
                                    - name: webhook.replicaCount
                                      value: "2"
                                    - name: cainjector.replicaCount
                                      value: "2"
                                    - name: resources.requests.cpu
                                      value: "100m"
                                    - name: resources.requests.memory
                                      value: "128Mi"
                                    - name: resources.limits.cpu
                                      value: "200m"
                                    - name: resources.limits.memory
                                      value: "256Mi"

                    patches:
                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.providerConfigRef
                          toFieldPath: spec.providerConfigRef.name

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: metadata.name
                          transforms:
                              - type: string
                                string:
                                    fmt: "%s-cert-manager"
                                    type: Format

                    readinessChecks:
                        - type: MatchString
                          fieldPath: status.atProvider.state
                          matchString: deployed

                  # Resource 4: Install ingress-nginx operator via Helm
                  # VERSION AND VALUES ARE HARDCODED - no user customization
                  - name: ingress-nginx-release
                    base:
                        apiVersion: helm.crossplane.io/v1beta1
                        kind: Release
                        metadata:
                            name: ingress-nginx
                        spec:
                            rollbackLimit: 3
                            forProvider:
                                chart:
                                    name: ingress-nginx
                                    repository: https://kubernetes.github.io/ingress-nginx
                                    version: 4.8.3 # HARDCODED VERSION
                                namespace: ingress-nginx
                                # HARDCODED VALUES - opinionated defaults
                                values:
                                    controller:
                                        replicaCount: 2
                                        service:
                                            type: NodePort
                                        resources:
                                            requests:
                                                cpu: 100m
                                                memory: 128Mi
                                            limits:
                                                cpu: 500m
                                                memory: 512Mi
                                        metrics:
                                            enabled: true

                    patches:
                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.providerConfigRef
                          toFieldPath: spec.providerConfigRef.name

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: metadata.name
                          transforms:
                              - type: string
                                string:
                                    fmt: "%s-ingress-nginx"
                                    type: Format

                    readinessChecks:
                        - type: MatchString
                          fieldPath: status.atProvider.state
                          matchString: deployed

                  # Resource 5: Create a verification ConfigMap
                  - name: bootstrap-verification
                    base:
                        apiVersion: kubernetes.crossplane.io/v1alpha2
                        kind: Object
                        metadata:
                            name: bootstrap-info
                        spec:
                            forProvider:
                                manifest:
                                    apiVersion: v1
                                    kind: ConfigMap
                                    metadata:
                                        name: bootstrap-info
                                        namespace: default
                                    data:
                                        bootstrapped: "true"
                                        pattern: "static"
                                        certManagerVersion: "v1.13.3"
                                        ingressNginxVersion: "4.8.3"

                    patches:
                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.providerConfigRef
                          toFieldPath: spec.providerConfigRef.name

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: spec.forProvider.manifest.data.clusterName

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: metadata.name
                          transforms:
                              - type: string
                                string:
                                    fmt: "%s-bootstrap-info"
                                    type: Format

                        - type: FromCompositeFieldPath
                          fromFieldPath: spec.targetCluster.name
                          toFieldPath: spec.forProvider.manifest.metadata.name
                          transforms:
                              - type: string
                                string:
                                    fmt: "%s-bootstrap-info"
                                    type: Format

        # Step 2: Auto-ready function marks the XR as Ready when all resources are ready
        - step: automatically-detect-ready-composed-resources
          functionRef:
              name: function-auto-ready
